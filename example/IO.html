<!DOCTYPE html>
<html>
<head>
    <script src="../src/main/javascript/monad.js" type="text/javascript"></script>
    <script src="bower_components/underscore/underscore-min.js" type="text/javascript"></script>
    <script src="bower_components/jquery/jquery.min.js" type="text/javascript"></script>
    <script src="wu-0.1.8.min.js" type="text/javascript"></script>
    <title>Example IO page</title>
</head>
<body>

<span id="SomeId">Some text</span>

<div>
    <span>first name: <input type="text" id="firstName"/> </span>
    <span>last name: <input type="text" id="lastName"/> </span>
    <span>postcode: <input type="text" id="postcode"/> </span>
</div>

<div>
    <span>Result:</span> <span id="result"></span>
</div>

<script>

    Function.prototype.autoCurry = function(n) {
        return wu.autoCurry(this, n);
    }

    function idFunction(id) {
        return id
    }

    var happyPerson = function (f, l, p) {
        return "Welcome " + f + " " + l + " who lives at " + p
    }.autoCurry()

    $("input").keyup(function () {
        var validate = function (label, value) {
            return value != "" ? Validation.success(value) : Validation.fail(["Please give a " + label])
        }.autoCurry()

        var firstNameValidation = monadT(getValForId("#firstName").map(validate("first name")))
        var lastNameValidation = monadT(getValForId("#lastName").map(validate("last name")))
        var postCodeValidation = monadT(getValForId("#postcode").map(validate("postcode/zip code")))


        // accumulate errors then convert back from a validation transformer.
        var personValidationIO = (postCodeValidation.ap(lastNameValidation.ap(firstNameValidation.map(happyPerson)))).perform()

        personValidationIO.map(function (v) {
            return v.cata(function (errors) {
                return _.reduce(errors, function (acc, e) {
                        return acc + "<div>"+e+"</div>"
                },"")
            }, idFunction)
        }).flatMap(writeHtml("#result")).run()
    })

    function getId(id) {
        return IO(function () {
            return $(id)
        })
    }

    var getTextForId = function (id) {
        return getId(id).map(getText)
    }

    var getValForId = function (id) {
        return getId(id).map(getVal)
    }

    var getText = function (o) {
        return o.text()
    }

    var getVal = function (o) {
        return o.val()
    }

    var writeText = function (id, text) {
        return IO(function () {
            $(id).text(text)
        })
    }.autoCurry()

    var writeHtml = function(id, html) {
        return IO(function () {
            $(id).html(html)
        })
    }.autoCurry()

    getId("#SomeId").map(getText).map(function (text) {
        return text + " now with awesomeness"
    }).flatMap(writeText("#SomeId")).run()

</script>

</body>
</html>